{{- $template := "vitae/_functions/style-merged" }}
{{- $mergedStyle := false }}
{{- $callingTemplate := .Template }}
{{- $templateChain := default (slice $callingTemplate $template) .TemplateChain }}

{{- $parentStyle := dict }}
{{- $parentValidStyles := dict }}
{{- $parentPath := default slice .ParentPath }}

{{- $style := dict }}
{{- $validStyles := dict }}

{{- $styleClass := slice }}

{{- with .MergedStyle }}
  {{- with .Style }}
    {{- $style = . }}
    {{- $parentStyle = . }}
  {{- end }}
  {{- with .ValidStyles }}
    {{- $validStyles = . }}
    {{- $parentValidStyles = . }}
  {{- end }}
{{- end }}

{{- with .Style }}
  {{- $style = merge $style . }}
{{- end }}
{{- with .ValidStyles }}
  {{- $validStyles = . }}
{{- end }}

{{- with .ParentStyle }}
  {{- $parentStyle = . }}
{{- end }}
{{- with .ParentValidStyles }}
  {{- $parentValidStyles = . }}
{{- end }}

{{- $stylePath := default slice .StylePath }}
{{- $inducedPath := default slice .InducedPath }}

{{- $debug := false }}
{{/* {{- if not (not (findRE `^/([^/]+-demo/)?$` page.RelPermalink)) }}
  {{- $debugCallingTemplates := slice "template" "_components/index" "_components/skills" }}
  {{- $debugCallingTemplates = slice "testcase" }}
  {{- range $debugCallingTemplates }}
    {{- $debug = or $debug (and (strings.Contains (index $templateChain 0) . ) ) -}}
  {{- end }}
{{- end }} */}}
{{- $debugPrefix := delimit $templateChain "->" }}
{{- with printf "%v%v%v"
    (cond (gt (len $stylePath) 0) (printf "stylePath=%v" $stylePath) "")
    (cond (and (gt (len $stylePath) 0) (gt (len $inducedPath) 0)) " | " "")
    (cond (gt (len $inducedPath) 0) (printf "inducedPath=%v" $inducedPath) "") }}
  {{- $debugPrefix = printf "%v %v: " $debugPrefix . }}
{{- else }}
  {{- $debugPrefix = printf "%v: " $debugPrefix }}
{{- end }}
{{- $errorPrefix := printf "%s%s" page $debugPrefix }}
{{- $warnPrefix := $errorPrefix }}

{{- if $debug }}
  {{- warnf "%vstyle-merged called with style=%v\nvalidStyles=%v\nparentStyle=%v\nparentValidStyles=%v" $debugPrefix
      (jsonify (dict "indent" "  ") $style)
      (jsonify (dict "indent" "  ") $validStyles)
      (jsonify (dict "indent" "  ") $parentStyle)
      (jsonify (dict "indent" "  ") $parentValidStyles) }}
{{- end }}

{{/* validationType:
     `valid_types`: acceptable native type of Hugo
         This allows validating params that may have arbitrary values, such as strings,
         or whose value is within a small set, such as bool
     `class`: how the value is turned into a CSS class value (if at all)
*/}}

{{- $resultStyle := dict }}
{{- $resultValidStyles := $validStyles }}

{{- $validationType := (dict
  "ANY_BOOL" (dict
    "valid_types" (slice "bool")
    "class" "boolean"
  )
  "ANY_STRING" (dict
    "valid_types" (slice "string" "int")
    "class" "ignore"
  )
  "ANY_INT" (dict
    "valid_types" (slice "int")
    "class" "value"
  )
) }}

{{- $mergeInducingParamValue := true }}

{{- with $style }}

  {{- range $key, $value := . }}

    {{/* We accept multiple values if and only if validValuesForKey is a slice */}}
    {{- $returnSlice := false }}

    {{/* {{- $resultingValueType := cond (reflect.IsSlice $validValuesForKey) "SLICE" "SCALAR" }} */}}

    {{- $paramToResultingValueList := slice }}

    {{/* {{- $validValuesForKey := index $resultValidStyles $key }} */}}
    {{- $keyPath := append $key $stylePath }}
    {{- $validValuesForKey := index $resultValidStyles $keyPath }}
    {{/* {{- warnf "%vresultValidStyles=%v\nindex resultValidStyles key=%v %v\nindex resultValidStyles keyPath=%v %v"
        $debugPrefix (jsonify (dict "indent" "  ") $resultValidStyles)
        $key  (jsonify (dict "indent" "  ") (index $resultValidStyles $key) )
        $keyPath  (jsonify (dict "indent" "  ") (index $resultValidStyles $keyPath) ) }} */}}

    {{- if ne (printf "%T" $validValuesForKey) "<nil>" }}

      {{/* If the value is a map, it applies to params nested deeper
           and we call this template recursively to handle this.
           We then merge the result at the right level to $style */}}
      {{- if reflect.IsMap $value }}

        {{- $subParams := (dict
          "TemplateChain" $templateChain
          "ParentStyle" $parentStyle
          "ParentValidStyles" $parentValidStyles
          "Style" $value
          "ValidStyles" $resultValidStyles
          "StylePath" $keyPath
          "InducedPath" $inducedPath
          "Debug" $debug
        ) }}

        {{- if $debug }}
          {{- warnf "%vkey=%v: value is map=%v\nRecursive call with subParams=%v"
              $debugPrefix $key (jsonify (dict "indent" "  ") $value)
              (jsonify (dict "indent" "  ") $subParams) }}
        {{- end }}

        {{- with $mergedStyleSub := partial $template $subParams }}
          {{- if $debug }}
            {{- warnf "%vkey=%v: recursive call with subParams=%v\nreturned mergedStyleSub=%v"
                $debugPrefix $key (jsonify (dict "indent" "  ") ($subParams))
                (jsonify (dict "indent" "  ") $mergedStyleSub) }}
          {{- end }}
          {{- $mergeParams := (dict
            "TemplateChain" $templateChain
            "Style" $resultStyle
            "ValidStyles" $resultValidStyles
            "AddStyle" $mergedStyleSub.Style
            "StylePath" slice
            "Debug" $debug
          ) }}
          {{- $subResultStyle := partial "merge_deep" $mergeParams }}
          {{- $resultStyle = merge $resultStyle $subResultStyle }}
          {{- if $debug }}
            {{- warnf "%vkey=%v: merge styles after recursive call: merge_deep call with mergeParams=%v\nreturned subResultStyle=%v\nresultStyle=%v"
                $debugPrefix $key (jsonify (dict "indent" "  ") ($mergeParams))
                (jsonify (dict "indent" "  ") $subResultStyle)
                (jsonify (dict "indent" "  ") $resultStyle) }}
          {{- end }}
        {{- end }}

      {{- else }}

        {{- $returnSlice = reflect.IsSlice $validValuesForKey }}
        {{- if reflect.IsSlice $value }}
          {{- if $returnSlice }}
            {{- range $value }}
              {{- $resultingValueListParams := (dict
                "TemplateChain" $templateChain
                "ValidStyles" $resultValidStyles
                "Key" $key
                "Value" .
                "StylePath" $stylePath
                "InducedPath" $inducedPath
                "Debug" $debug
              ) }}
              {{- $paramToResultingValueListSub := partial "resulting_value_list" $resultingValueListParams }}
              {{- if and false $debug }}
                {{- warnf "%vkey=%v: call to resulting_value_list returned paramToResultingValueListSub=%v"
                    $debugPrefix $key (jsonify (dict "indent" "  ") $paramToResultingValueListSub) }}
              {{- end }}
              {{- if ne (printf "%T" $paramToResultingValueListSub) "<nil>" }}
                {{- if gt (len $paramToResultingValueListSub) 0 }}
                  {{- $paramToResultingValueList = append $paramToResultingValueListSub $paramToResultingValueList }}
                {{- end }}
              {{- end }}
            {{- end }}
          {{- else }}
            {{- errorf "%vkey=%v: %vInvalid value=%v [type=%T]: must not be slice as returnSlice=%v == (reflect.IsSlice validValuesForKey)=%v [type=%T] with validValuesForKey=%v"
                $errorPrefix $key $value $value $returnSlice (reflect.IsSlice $validValuesForKey) $validValuesForKey (jsonify (dict "indent" "  ") $validValuesForKey) }}
          {{- end }}

        {{- else }}
          {{- $resultingValueListParams := (dict
            "TemplateChain" $templateChain
            "ValidStyles" $resultValidStyles
            "Key" $key
            "Value" $value
            "StylePath" $stylePath
            "InducedPath" $inducedPath
            "Debug" $debug
          ) }}
          {{- $paramToResultingValueListSub := partial "resulting_value_list" $resultingValueListParams }}
          {{- if ne (printf "%T" $paramToResultingValueListSub) "<nil>" }}
            {{- if gt (len $paramToResultingValueListSub) 0 }}
              {{- $paramToResultingValueList = append $paramToResultingValueListSub $paramToResultingValueList }}
              {{- if and false $debug }}
                {{- warnf "%vkey=%v: call to resulting_value_list returned paramToResultingValueListSub=%v"
                    $debugPrefix $key (jsonify (dict "indent" "  ") $paramToResultingValueListSub) }}
              {{- end }}
            {{- end }}
          {{- end }}
        {{- end }}

      {{- end }}

      {{- range $paramToResultingValue := $paramToResultingValueList }}

        {{- if and false $debug }}
          {{- warnf "%vkey=%v: value=%v [type=%T] returnSlice=%v: process paramToResultingValue=%v"
              $debugPrefix $key $value $value $returnSlice
              (jsonify (dict "indent" "  ") $paramToResultingValue) }}
        {{- end }}

        {{- $paramValue := $paramToResultingValue.ParamValue }}
        {{- $resultingValue := $paramToResultingValue.ResultingValue }}
        {{- if reflect.IsSlice $paramToResultingValue.ResultingValue }}
          {{- $resultingValue = index $paramToResultingValue.ResultingValue 0 }}
        {{- end }}

        {{- $addStyle := dict }}

        {{- if reflect.IsMap $resultingValue }}
          {{- if (gt (len $inducedPath) 5 ) }}
            {{- errorf "%vkey=%v: aborting induced call chain at inducedPath=%v"
                  $errorPrefix $key $inducedPath }}
          {{- else }}
            {{/* As the resultingValue is a map means, we treat the resultingValue
                as if it had been passed as $style:
                We call $template with Style = resultingValue
                But we still use ValidStyles = validStyles because the
                resultingValue applies to the top-level validStyles */}}
            {{- $keyPath := append $key $stylePath }}
            {{- $validValuesForKey := index $resultValidStyles $keyPath }}

            {{- if ne (printf "%T" $validValuesForKey) "<nil>" }}
              {{- $subParams := (dict
                "TemplateChain" $templateChain
                "ParentStyle" $parentStyle
                "ParentValidStyles" $parentValidStyles
                "Style" $resultingValue
                "ValidStyles" $resultValidStyles
                "StylePath" slice
                "InducedPath" (append $key $inducedPath)
                "Debug" $debug
              ) }}
              {{- if $debug }}
                {{- warnf "%vkey=%v: value=%v [type=%T] -> resultingValue MAP=%v\nInduced call with subParams=%v"
                    $debugPrefix $key $value $value (jsonify (dict "indent" "  ") $resultingValue)
                    (jsonify (dict "indent" "  ") $subParams) }}
              {{- end }}

              {{- with $mergedStyleSub := partial $template $subParams }}

                {{- if ne (printf "%T" $mergedStyleSub) "<nil>" }}
                  {{- $addStyle = index $mergedStyleSub.Style $stylePath }}
                  {{- if $debug }}
                    {{- warnf "%vkey=%v: addStyle=%v\nfrom result of induced call: mergedStyleSub=%v"
                        $debugPrefix $key (jsonify (dict "indent" "  ") $addStyle)
                        (jsonify (dict "indent" "  ") $mergedStyleSub) }}
                  {{- end }}

                  {{- if $mergeInducingParamValue }}

                    {{- $parentValidValuesForKey := index $parentValidStyles $keyPath }}
                    {{- if $debug }}
                      {{- warnf "%vkey=%v: value=%v [type=%T] keyPath=%v mergeInducingParamValue with paramValue=%v\nparentValidStyles=%v\nparentValidValuesForKey=%v\nyielded style=%v\nvalidStyles=%v"
                          $debugPrefix $key $value $value $keyPath (jsonify (dict "indent" "  ") $paramValue)
                          (jsonify (dict "indent" "  ") $parentValidStyles)
                          (jsonify (dict "indent" "  ") $parentValidValuesForKey)
                          (jsonify (dict "indent" "  ") $resultStyle)
                          (jsonify (dict "indent" "  ") $resultValidStyles) }}
                    {{- end }}

                    {{- with $parentValidValuesForKey }}
                      {{/* {{- $resultStyle = merge $resultStyle (dict $key (index $parentStyle $key) ) }} */}}
                      {{- $resultStyle = merge (dict $keyPath (index $parentStyle $keyPath) ) $resultStyle }}
                      {{/* {{- $resultValidStyles = merge $resultValidStyles (dict $key $parentValidValuesForKey) }} */}}
                      {{- $resultValidStyles = merge (dict $keyPath $parentValidValuesForKey) $resultValidStyles }}
                    {{- end }}
                  {{- end }}

                {{- else }}

                  {{- errorf "%vkey=%v: induced call failed for resultingValue=%v\nwith subParams=%v"
                      $errorPrefix $key (jsonify (dict "indent" "  ") $resultingValue)
                    (jsonify (dict "indent" "  ") $subParams) }}

                {{- end }}

              {{- end }}

            {{- else }}
              {{- errorf "%vkey=%v: cannot make induced call with resultingValue=%v as key=%v yielded validValuesForKey=%v"
                  $errorPrefix $key (jsonify (dict "indent" "  ") $resultingValue)
                  $key $validValuesForKey }}
            {{- end }}
          {{- end }}

        {{- else }}

          {{- if ne (printf "%T" $paramToResultingValue) "<nil>" }}

            {{- if $returnSlice }}
              {{- if $debug }}
                {{- warnf "%vkey=%v: value=%v [type=%T] -> resultingValue=%v: turn into a slice as value is a slice"
                    $debugPrefix $key $value $value $resultingValue }}
              {{- end }}
              {{- $resultingValue = slice $resultingValue }}
            {{- end }}

            {{- $addStyle = (dict $key $resultingValue) }}

          {{- else }}

            {{- errorf "%vkey=%v: Invalid paramToResultingValue=%v"
                $errorPrefix $key (jsonify (dict "indent" "  ") $paramToResultingValue) }}

          {{- end }}

        {{- end }}

        {{- $mergeParams := (dict
          "TemplateChain" $templateChain
          "Style" $resultStyle
          "ValidStyles" $resultValidStyles
          "AddStyle" $addStyle
          "StylePath" $stylePath
          "Debug" $debug
        ) }}
        {{- $subResultStyle := partial "merge_deep" $mergeParams }}
        {{- $resultStyle = merge $resultStyle $subResultStyle }}
        {{- if $debug }}
          {{- warnf "%vkey=%v: merge_deep call with mergeParams=%v\nreturned subResultStyle=%v\nresultStyle=%v"
              $debugPrefix $key (jsonify (dict "indent" "  ") ($mergeParams))
              (jsonify (dict "indent" "  ") $subResultStyle)
              (jsonify (dict "indent" "  ") $resultStyle) }}
        {{- end }}

      {{- end }}

    {{- else }}

      {{- $errorDict := printf `"%v": "%v"` $key $value }}
      {{- if or (reflect.IsMap $value) (reflect.IsSlice $value) }}
        {{- $errorDict = printf "\n%v" (jsonify (dict "indent" "  ") (dict $key $value)) }}
      {{- end }}

      {{- if $debug }}
        {{- warnf "%vIgnoring unknown style:%v\nNo entry for this key exists in validStyles=%v"
          $errorPrefix $errorDict
          (jsonify (dict "indent" "  ") $validStyles) }}
      {{- end }}

    {{- end }}

  {{- end }}

  {{- if and (eq (len $stylePath) 0) (eq (len $parentPath) 0) (eq (len $inducedPath) 0) }}

    {{- if $resultStyle }}
      {{- $styleClassParams := (dict
        "TemplateChain" $templateChain
        "Style" $resultStyle
        "ValidStyles" $resultValidStyles
        "ValidationType" $validationType
        "Debug" $debug
      ) }}
      {{- $styleClass = append (partial "style_class" $styleClassParams) $styleClass }}
    {{- end }}

  {{- end }}

{{- end }}

{{- $mergedStyle = (dict
  "Style" $resultStyle
  "ValidStyles" $resultValidStyles
  "StyleClass" $styleClass
) -}}

{{- if $debug }}
  {{- warnf "%vEnd of style-merged: Returning mergedStyle=%v" $debugPrefix
      (jsonify (dict "indent" "  ") $mergedStyle) }}
{{- end }}

{{- return $mergedStyle }}

{{- /* ***************************************************************** */ -}}

{{- define "partials/resulting_value_list.html" }}
  {{- $template := "resulting_value_list" }}
  {{- $templateChain := append $template .TemplateChain }}
  {{- $key := .Key }}
  {{- $value := .Value }}
  {{- $validStyles := .ValidStyles }}
  {{- $stylePath := default slice .StylePath }}
  {{- $inducedPath := default slice .InducedPath }}

  {{- $debug := false }}
  {{/* {{- $debug = or $debug .Debug }} */}}

  {{- $debugPrefix := delimit $templateChain "->" }}
  {{- with printf "%v%v%v"
      (cond (gt (len $stylePath) 0) (printf "stylePath=%v" $stylePath) "")
      (cond (and (gt (len $stylePath) 0) (gt (len $inducedPath) 0)) " | " "")
      (cond (gt (len $inducedPath) 0) (printf "inducedPath=%v" $inducedPath) "") }}
    {{- $debugPrefix = printf "%v %v: " $debugPrefix . }}
  {{- else }}
    {{- $debugPrefix = printf "%v: " $debugPrefix }}
  {{- end }}
  {{- $errorPrefix := printf "%s%s" page $debugPrefix }}
  {{- $warnPrefix := $errorPrefix }}

  {{- $paramToResultingValueList := slice }}
  {{/* {{- $validValuesForKey := index $validStyles $key }} */}}
  {{- $keyPath := $key }}
  {{- with $stylePath }}
    {{- $keyPath = append $key $stylePath }}
  {{- end }}
  {{- $validValuesForKey := index $validStyles $keyPath }}
  {{/* {{- warnf "%vvalidStyles=%v\nindex validStyles key=%v %v\nindex validStyles keyPath=%v %v"
      $debugPrefix (jsonify (dict "indent" "  ") $validStyles)
      $key  (jsonify (dict "indent" "  ") (index $validStyles $key) )
      $keyPath  (jsonify (dict "indent" "  ") (index $validStyles $keyPath) ) }} */}}
  {{- if $debug }}
    {{- warnf "%vresulting_value_list called with value=%v\n with validValuesForKey=%v"
        $debugPrefix (jsonify (dict "indent" "  ") $value)
        (jsonify (dict "indent" "  ") $validValuesForKey) }}
  {{- end }}

  {{- $returnSlice := reflect.IsSlice $validValuesForKey }}

  {{- if reflect.IsMap $value }}

    {{- if $debug }}
      {{- warnf "%vkey=%v: determine resultingValue from MAP based on entry for value=%v in validValuesForKey=%v"
          $debugPrefix $key $value (jsonify (dict "indent" "  ") $validValuesForKey) }}
    {{- end }}

    {{- range $innerKey, $innerValue := $value }}

      {{- if $debug }}
        {{- warnf "%vkey=%v: looking for innerKey=%v in validValuesForKey=%v"
            $debugPrefix $key $innerKey
            (jsonify (dict "indent" "  ") $validValuesForKey) }}
      {{- end }}

      {{- $resultingValue := index $validValuesForKey (string $innerKey) }}
      {{- if ne (printf "%T" $resultingValue) "<nil>" }}
        {{- if and $returnSlice (not reflect.IsSlice $resultingValue) }}
          {{- $resultingValue = slice $resultingValue }}
          {{- if $debug }}
            {{- warnf "%vkey=%v: wrapped resultingValue in slice=%v based on entry for innerKey=%v in validValuesForKey=%v"
                $debugPrefix $key $innerKey (jsonify (dict "indent" "  ") $validValuesForKey) }}
          {{- end }}
        {{- end }}
        {{- $paramToResultingValueList = append (dict "ParamValue" $innerValue "ResultingValue" $resultingValue) $paramToResultingValueList }}
      {{- else }}
        {{- errorf "%vkey=%v: Invalid value=%v [type=%T]: innerKey=%v not found in validValuesForKey=%v"
            $errorPrefix $key $value $value $innerKey
            (jsonify (dict "indent" "  ") $validValuesForKey) }}
      {{- end }}
    {{- end }}

    {{- if $debug }}
      {{- warnf "%vkey=%v: paramToResultingValueList=%v\nFrom MAP value=%v [type=%T]"
          $debugPrefix $key $paramToResultingValueList $value $value }}
    {{- end }}

  {{- else if reflect.IsSlice $value }}

    {{- if $debug }}
      {{- warnf "%vkey=%v: determine resultingValue from SLICE based on entry for value=%v in validValuesForKey=%v"
          $debugPrefix $key $value (jsonify (dict "indent" "  ") $validValuesForKey) }}
    {{- end }}

    {{/* We accept all values in the intersection between value and validValuesForKey
          but since the values may be maps, we need to use a loop */}}
    {{- range $innerValue := $value }}
      {{- $resultingValueParams := (dict
        "TemplateChain" $templateChain
        "ValidStyles" $validStyles
        "ValidValuesForKey" $validValuesForKey
        "Key" $key
        "Value" $innerValue
        "StylePath" $stylePath
        "InducedPath" $inducedPath
        "Debug" $debug
      ) }}
      {{- $paramToResultingValueSub := partial "resulting_value" $resultingValueParams }}
      {{- if ne (printf "%T" $paramToResultingValueSub.ResultingValue) "<nil>" }}
        {{- $paramToResultingValueList = append $paramToResultingValueSub $paramToResultingValueList }}
        {{- if $debug }}
          {{- warnf "%vkey=%v: call with resultingValueParams=%v\nreturned paramToResultingValueSub=%v"
              $debugPrefix $key (jsonify (dict "indent" "  ") ($resultingValueParams))
              (jsonify (dict "indent" "  ") $paramToResultingValueSub) }}
        {{- end }}
      {{- else }}
        {{- errorf "%vkey=%v Invalid value=%v [type=%T]: resulting_value returned %v[type=%T] for resultingValueParams=%v"
            $errorPrefix $key $value $value $paramToResultingValueSub.ResultingValue
            $paramToResultingValueSub.ResultingValue
            (jsonify (dict "indent" "  ") $resultingValueParams) }}
      {{- end }}
    {{- end }}
    {{- if $debug }}
      {{- warnf "%vkey=%v: paramToResultingValueList=%v\nFrom SLICE value=%v [type=%T]"
          $debugPrefix $key $paramToResultingValueList $value $value }}
    {{- end }}

  {{- else }}

    {{- if $debug }}
      {{- warnf "%vkey=%v: determine resultingValue from SCALAR based on entry for value=%v in validValuesForKey=%v"
          $debugPrefix $key $value (jsonify (dict "indent" "  ") $validValuesForKey) }}
    {{- end }}

    {{- $resultingValueParams := (dict
      "TemplateChain" $templateChain
      "ValidStyles" $validStyles
      "ValidValuesForKey" $validValuesForKey
      "Key" $key
      "Value" $value
      "StylePath" $stylePath
      "InducedPath" $inducedPath
      "Debug" $debug
    ) }}
    {{- $paramToResultingValueSub := partial "resulting_value" $resultingValueParams }}
    {{- if ne (printf "%T" $paramToResultingValueSub.ResultingValue) "<nil>" }}
      {{- $paramToResultingValueList = append $paramToResultingValueSub $paramToResultingValueList }}
      {{- if $debug }}
        {{- warnf "%vkey=%v: call with resultingValueParams=%v\nreturned paramToResultingValueSub=%v"
            $debugPrefix $key (jsonify (dict "indent" "  ") ($resultingValueParams))
            (jsonify (dict "indent" "  ") $paramToResultingValueSub) }}
      {{- end }}
    {{- else }}
      {{- errorf "%vkey=%v Invalid value=%v [type=%T]: resulting_value returned %v[type=%T] for resultingValueParams=%v"
          $errorPrefix $key $value $value $paramToResultingValueSub.ResultingValue
          $paramToResultingValueSub.ResultingValue
          (jsonify (dict "indent" "  ") $resultingValueParams) }}
    {{- end }}

    {{- if $debug }}
      {{- warnf "%vkey=%v: paramToResultingValueList=%v\nFrom  SCALAR value=%v [type=%T]"
          $debugPrefix $key $paramToResultingValueList $value $value }}
    {{- end }}

  {{- end }}

  {{- if $debug }}
    {{- warnf "%vReturning paramToResultingValueList=%v"
      $debugPrefix
      (jsonify (dict "indent" "  ") $paramToResultingValueList) }}
  {{- end }}

  {{- return $paramToResultingValueList }}

{{- end }}

{{- define "partials/resulting_value.html" }}
  {{- $template := "resulting_value" }}
  {{- $templateChain := append $template .TemplateChain }}
  {{- $key := .Key }}
  {{- $value := .Value }}
  {{- $validValuesForKey := .ValidValuesForKey }}
  {{- $stylePath := default slice .StylePath }}
  {{- $inducedPath := default slice .InducedPath }}

  {{- $debug := false }}
  {{/* {{- $debug = or $debug .Debug }} */}}

  {{- $debugPrefix := delimit $templateChain "->" }}
  {{- with printf "%v%v%v"
      (cond (gt (len $stylePath) 0) (printf "stylePath=%v" $stylePath) "")
      (cond (and (gt (len $stylePath) 0) (gt (len $inducedPath) 0)) " | " "")
      (cond (gt (len $inducedPath) 0) (printf "inducedPath=%v" $inducedPath) "") }}
    {{- $debugPrefix = printf "%v %v: " $debugPrefix . }}
  {{- else }}
    {{- $debugPrefix = printf "%v: " $debugPrefix }}
  {{- end }}
  {{- $errorPrefix := printf "%s%s" page $debugPrefix }}
  {{- $warnPrefix := $errorPrefix }}

  {{- if $debug }}
    {{- warnf "%vresulting_value called with value=%v\n with validValuesForKey=%v"
        $debugPrefix (jsonify (dict "indent" "  ") $value)
        (jsonify (dict "indent" "  ") $validValuesForKey) }}
  {{- end }}

  {{- $paramToResultingValue := (dict
    "ParamValue" $value
    "ResultingValue" nil
  ) }}

  {{- $returnSlice := reflect.IsSlice $validValuesForKey }}

  {{- if reflect.IsMap $validValuesForKey }}
    {{- $resultingValue := index $validValuesForKey (string $value) }}
    {{- if ne (printf "%T" $resultingValue) "<nil>" }}
      {{- $paramToResultingValue = merge $paramToResultingValue (dict
        "ResultingValue" $resultingValue
      ) }}
      {{- if $debug }}
        {{- warnf "%vvalue=%v: validValuesForKey is MAP: resultingValue=%v == entry of value=%v in validValuesForKey=%v"
            $debugPrefix $value $resultingValue $value (jsonify (dict "indent" "  ") $validValuesForKey) }}
      {{- end }}
    {{- else }}
      {{- errorf "%vkey=%v Invalid value=%v [type=%T]: no entry for this value in validValuesForKey=%v"
          $errorPrefix $key $value $value (jsonify (dict "indent" "  ") $validValuesForKey) }}
    {{- end }}
  {{- else if reflect.IsSlice $validValuesForKey }}
    {{/* Every entry in the slice $validValuesForKey can be either
          1.  A scalar value, e.g. "inline"
          2.  A map with exactly one key, e.g. (dict "inline" (dict "inline" (slice "header" "content") )
          Anything else, i.e., a slice, is invalid */}}
    {{- if $debug }}
      {{- warnf "%vvalue=%v: validValuesForKey is SLICE: validValuesForKey=%v"
          $debugPrefix $value (jsonify (dict "indent" "  ") $validValuesForKey) }}
    {{- end }}

    {{- $resultingValue := slice }}

    {{- range $candValue := $validValuesForKey }}
      {{- if reflect.IsMap $candValue }}
        {{- $valueAdded := false }}
        {{- range $innerKey, $innerValue := $candValue }}
          {{- if not $valueAdded }}
            {{- if eq $innerKey $value }}
              {{- if $debug }}
                {{- warnf "%vAppend innerValue=%v with innerKey=%v == value=%v to $resultingValue=%v"
                    $debugPrefix $innerValue $innerKey $value $resultingValue }}
              {{- end }}
              {{- $valueAdded = true }}
              {{- $resultingValue = append $innerValue $resultingValue }}
            {{- else }}
              {{- if $debug }}
                {{- warnf "%vDo not append innerValue=%v != value=%v to $resultingValue=%v"
                    $debugPrefix $value $innerValue $resultingValue }}
              {{- end }}
            {{- end }}
          {{- else }}
            {{- errorf "%vkey=%v: Invalid value=%v [type=%T]: must be a scalar or a map with exactly one key given validValuesForKey=%v"
                $errorPrefix $key $value $value (jsonify (dict "indent" "  ") $validValuesForKey) }}
          {{- end }}
        {{- end }}
      {{- else if reflect.IsSlice $candValue }}
        {{- errorf "%vkey=%v: Invalid value=%v [type=%T]: must be a a map or a scalar given validValuesForKey is a slice=%v"
            $errorPrefix $key $value $value (jsonify (dict "indent" "  ") $validValuesForKey) }}
      {{- else }}
        {{- if eq $candValue $value }}
          {{- if $debug }}
            {{- warnf "%vAppend candValue=%v == value=%v to $resultingValue=%v"
                $debugPrefix $value $candValue $resultingValue }}
          {{- end }}
          {{- $resultingValue = append $candValue $resultingValue }}
        {{- else }}
          {{- if $debug }}
            {{- warnf "%vDo not append candValue=%v != value=%v to $resultingValue=%v"
                $debugPrefix $value $candValue $resultingValue }}
          {{- end }}
        {{- end }}
      {{- end }}
    {{- end }}

    {{- if gt (len $resultingValue) 0 }}
      {{- $paramToResultingValue = merge $paramToResultingValue (dict
        "ResultingValue" $resultingValue
      ) }}
    {{- else }}
    {{- end }}

  {{- else }}

    {{- $resultingValue := $value }}

    {{- if $debug }}
      {{- warnf "%vvalidValuesForKey is SCALAR: resultingValue=%v == value=%v in validValuesForKey=%v"
          $debugPrefix $resultingValue $value (jsonify (dict "indent" "  ") $validValuesForKey) }}
    {{- end }}

    {{- $paramToResultingValue = merge $paramToResultingValue (dict
      "ResultingValue" $resultingValue
    ) }}

  {{- end }}

  {{- if $debug }}
    {{- warnf "%vReturning paramToResultingValue=%v"
      $debugPrefix
      (jsonify (dict "indent" "  ") $paramToResultingValue) }}
  {{- end }}

  {{- return $paramToResultingValue }}

{{- end }}

{{- /* ***************************************************************** */ -}}

{{- define "partials/merge_deep.html" }}
  {{- $template := "merge_deep" }}
    {{- $templateChain := append $template .TemplateChain }}
  {{- $style := .Style }}
  {{- $validStyles := .ValidStyles }}
  {{- $addStyle := .AddStyle }}
  {{- $stylePath := default slice .StylePath }}
  {{- $inducedPath := default slice .InducedPath }}

  {{- $debug := false }}
  {{- $debug = or $debug .Debug }}

  {{- $debugPrefix := delimit $templateChain "->" }}
  {{- with printf "%v%v%v"
      (cond (gt (len $stylePath) 0) (printf "stylePath=%v" $stylePath) "")
      (cond (and (gt (len $stylePath) 0) (gt (len $inducedPath) 0)) " | " "")
      (cond (gt (len $inducedPath) 0) (printf "inducedPath=%v" $inducedPath) "") }}
    {{- $debugPrefix = printf "%v %v: " $debugPrefix . }}
  {{- else }}
    {{- $debugPrefix = printf "%v: " $debugPrefix }}
  {{- end }}
  {{- $errorPrefix := printf "%s%s" page $debugPrefix }}
  {{- $warnPrefix := $errorPrefix }}

  {{- if $debug }}
    {{- warnf "%vmerge_deep called with addStyle=%v\nto style=%v\nwith validStyles=%v"
        $debugPrefix (jsonify (dict "indent" "  ") $addStyle)
        (jsonify (dict "indent" "  ") $style) (jsonify (dict "indent" "  ") $validStyles) }}
  {{- end }}

  {{- $resultStyle := dict }}

  {{- range $key, $value := $addStyle }}
    {{- $keyPath := append $key $stylePath }}
    {{- if reflect.IsMap $value }}
      {{- $subParams := (dict
        "TemplateChain" $templateChain
        "Style" $style
        "ValidStyles" $validStyles
        "AddStyle"  $value
        "StylePath" $keyPath
        "InducedPath" $inducedPath
        "Debug" $debug
      ) }}

      {{- if $debug }}
        {{- warnf "%vkey=%v: value in addStyle is a map: recursive call with subParams=%v"
            $debugPrefix $key
            (jsonify (dict "indent" "  ") ($subParams)) }}
      {{- end }}

      {{- with $mergedStyleSub := partial $template $subParams }}
        {{- $resultStyle = merge $resultStyle (index $mergedStyleSub $stylePath) }}
        {{- if $debug }}
          {{- warnf "%vkey=%v: recursive call due to value being a map with subParams=%v\nreturned mergedStyleSub=%v\nmerged to resultStyle=%v"
              $debugPrefix $key
              (jsonify (dict "indent" "  ") ($subParams))
              (jsonify (dict "indent" "  ") ($mergedStyleSub))
              (jsonify (dict "indent" "  ") $resultStyle) }}
        {{- end }}
      {{- end }}

    {{- else }}

      {{- $validValuesForKey := index $validStyles $keyPath }}

      {{- if ne (printf "%T" $validValuesForKey) "<nil>" }}
        {{- $returnSlice := reflect.IsSlice $validValuesForKey }}
        {{- $baseValue := index $style $key }}
        {{- if ne (printf "%T" $baseValue) "<nil>" }}

          {{- if reflect.IsMap $baseValue }}
            {{- errorf "%vkey=%v: validValuesForKey=%v: invalid baseValue=%v in style=%v"
                $errorPrefix $key $validValuesForKey $baseValue
                (jsonify (dict "indent" "  ") $style) }}

          {{- else }}

            {{- if reflect.IsSlice $value }}

              {{- if not $returnSlice }}
                {{- errorf "%vkey=%v: validValuesForKey=%v is not a slice, hence value=%v must not be a slice either in addStyle=%v"
                    $errorPrefix $key $validValuesForKey $value
                    (jsonify (dict "indent" "  ") $addStyle) }}
              {{- end  }}

              {{/* Append value to baseValue */}}
              {{- $baseValueList := $baseValue }}
              {{- if not (reflect.IsSlice $baseValueList) }}
                {{- $baseValueList = slice $baseValue }}
              {{- end }}
              {{- if $debug }}
                {{- warnf "%vkey=%v: union value=%v[%T] to baseValueList=%v[%T] in resultStyle=%v"
                    $debugPrefix $key $value $value $baseValueList $baseValueList
                    (jsonify (dict "indent" "  ") $resultStyle) }}
              {{- end }}
              {{- $resultStyle = merge $resultStyle (dict $key (union $value $baseValueList)) }}
              {{- if $debug }}
                {{- warnf "%vkey=%v: added value=%v to baseValueList=%v in resultStyle=%v"
                    $debugPrefix $key $value $baseValueList
                    (jsonify (dict "indent" "  ") $resultStyle) }}
              {{- end }}

            {{- else }}

              {{/* Given that the base value is a scalar, we assume that
                    a SCALAR is expected to be returned */}}

              {{/* Overwrite baseValue with value */}}
              {{- $resultStyle = merge $resultStyle (dict $key $value) }}

              {{- if $debug }}
                {{- warnf "%vkey=%v: validValuesForKey=%v: baseValue=%v overwritten by value=%v in resultStyle=%v"
                    $debugPrefix $key $validValuesForKey $baseValue $value
                    (jsonify (dict "indent" "  ") $resultStyle) }}
              {{- end }}

            {{- end }}

          {{- end }}

        {{- else }}

          {{/* Add value */}}

          {{- if reflect.IsSlice $value }}

            {{- if not $returnSlice }}
              {{- errorf "%vkey=%v: validValuesForKey=%v is not a slice, hence value=%v must not be a slice either in addStyle=%v"
                  $errorPrefix $key $validValuesForKey $value
                  (jsonify (dict "indent" "  ") $addStyle) }}
            {{- end  }}

          {{- else }}

            {{- if $returnSlice }}
              {{- errorf "%vkey=%v: validValuesForKey=%v is a slice, hence value=%v must be a slice as well in addStyle=%v"
                  $errorPrefix $key $validValuesForKey $value
                  (jsonify (dict "indent" "  ") $addStyle) }}
            {{- end  }}

          {{- end }}

          {{- $resultStyle = merge $resultStyle (dict $key $value) }}
          {{- if $debug }}
            {{- warnf "%vkey=%v: added value=%v to resultStyle=%v"
                $debugPrefix $key $value
                (jsonify (dict "indent" "  ") $resultStyle) }}
          {{- end }}

        {{- end }}

      {{- else }}

        {{- errorf "%vkey=%v: no entry found for key=%v in validStyles=%v"
            $errorPrefix $key $key
            (jsonify (dict "indent" "  ") $validStyles) }}

      {{- end }}

    {{- end }}
  {{- end }}

  {{- $mergedResultStyle := false }}
  {{- with $stylePath }}
    {{- $mergedResultStyle = merge $style (dict $stylePath $resultStyle) }}
  {{- else }}
    {{- $mergedResultStyle = merge $style $resultStyle }}
  {{- end }}

  {{- if $debug }}
    {{- warnf "%vMerging resultStyle=%v\nto style=%v\nat stylePath=%v yielded mergedResultStyle=%v"
        $debugPrefix
        (jsonify (dict "indent" "  ") $resultStyle)
        (jsonify (dict "indent" "  ") $style) $stylePath
        (jsonify (dict "indent" "  ") $mergedResultStyle) }}

      {{- warnf "%vReturning mergedResultStyle=%v"
        $debugPrefix
        (jsonify (dict "indent" "  ") $mergedResultStyle) }}
  {{- end }}
  {{- return $mergedResultStyle }}
{{- end }}

{{- /* ***************************************************************** */ -}}

{{- define "partials/style_class" }}
  {{- $template := "style_class" }}
    {{- $templateChain := append $template .TemplateChain }}
  {{- $style := .Style }}
  {{- $validStyles := .ValidStyles }}
  {{- $stylePath := default slice .StylePath }}
  {{- $inducedPath := default slice .InducedPath }}

  {{- $styleClassPrefix := default "style_" .StyleClassPrefix }}
  {{- $validationType := .ValidationType }}

  {{- $debug := false }}
  {{/* {{- $debug = or $debug .Debug }} */}}

  {{- $debugPrefix := delimit $templateChain "->" }}
  {{- with printf "%v%v%v"
      (cond (gt (len $stylePath) 0) (printf "stylePath=%v" $stylePath) "")
      (cond (and (gt (len $stylePath) 0) (gt (len $inducedPath) 0)) " | " "")
      (cond (gt (len $inducedPath) 0) (printf "inducedPath=%v" $inducedPath) "") }}
    {{- $debugPrefix = printf "%v %v]: " $debugPrefix . }}
  {{- else }}
    {{- $debugPrefix = printf "%v]: " $debugPrefix }}
  {{- end }}
  {{- $errorPrefix := printf "%s[%s" page $debugPrefix }}
  {{- $warnPrefix := $errorPrefix }}

  {{- if $debug }}
    {{- warnf "%vstyle_class called with style=%v\nvalidStyles=%v\nvalidationType=%v"
        $debugPrefix
        (jsonify (dict "indent" "  ") $style)
        (jsonify (dict "indent" "  ") $validStyles)
        (jsonify (dict "indent" "  ") $validationType) }}
  {{- end }}

  {{- $styleClass := slice }}

  {{- with $style }}
    {{- range $key, $value := . }}
      {{- $keyStylePath := append $key $stylePath }}

      {{- if eq (printf "%T" $value) "<nil>" }}
      {{- else if reflect.IsMap $value }}
        {{- $subParams := (dict
          "TemplateChain" $templateChain
          "Style" $value
          "ValidStyles" (index $validStyles $key)
          "StylePath" $keyStylePath
          "InducedPath" $inducedPath
          "StyleClassPrefix" $styleClassPrefix
          "ValidationType" $validationType
          "Debug" $debug
        ) }}
        {{- if $debug }}
          {{- warnf "%vkey=%v: value for this key is a map: recursive call with subParams=%v"
              $debugPrefix $key (jsonify (dict "indent" "  ") $subParams) }}
        {{- end }}

        {{- with $styleClassSub := partial $template $subParams }}
          {{- $styleClass = append $styleClassSub $styleClass }}
        {{- end }}

      {{- else if reflect.IsSlice $value }}

        {{/* Given that this is a slice, we expect that all its elements are scalar */}}
        {{- range $value }}
          {{- if reflect.IsMap . }}
            {{- errorf "%vkey=%v: value for this key is a map: this should never happen"
                $errorPrefix $key -}}
          {{- else if reflect.IsSlice . }}
            {{- errorf "%vkey=%v: value for this key is a map: this should never happen"
                $errorPrefix $key -}}
          {{- else }}
            {{- $styleClass = append (printf "%s%s_%v" $styleClassPrefix (delimit $keyStylePath `_`) .) $styleClass }}
          {{- end }}
        {{- end }}

      {{- else }}

        {{/* Given that this is a scalar, we expect it to be validated against a map or a scalar */}}
        {{- $valueHandled := false }}

        {{- $validationSpec := index $validStyles $key }}
        {{- if and false $debug }}
          {{- warnf "%vkey=%v process value=%v [type=%T]: validationSpec=%v"
              $debugPrefix $key $value $value $validationSpec }}
        {{- end }}

        {{- if ne (printf "%T" $validationSpec) "<nil>" }}

          {{- if reflect.IsMap $validationSpec }}

            {{- $resultingValue := index $validationSpec (string $value) }}
            {{- if ne (printf "%T" $resultingValue) "<nil>" }}
              {{- $styleClass = append (printf "%s%s_%v" $styleClassPrefix (delimit $keyStylePath `_`) .) $styleClass }}
              {{- $valueHandled = true }}
              {{- if $debug }}
                {{- warnf "%vkey=%v validated against MAP: value=%v [type=%T] resultingValue=%v"
                    $debugPrefix $key $value $value $resultingValue }}
              {{- end }}
            {{- else }}
              {{- errorf "%vkey=%v: value=%v [type=%T] string='%s' not found in validationSpec=%v"
                  $errorPrefix $key $value $value (string $value) (jsonify (dict "indent" "  ") $validationSpec) -}}
            {{- end }}

          {{- else }}

            {{- $validationTypeSpec := index $validationType (string $validationSpec) }}

            {{- if and false $debug }}
              {{- warnf "%vkey=%v process value=%v [type=%T]: validationSpec=%v [type=%T]"
                  $debugPrefix $key $value $value $validationSpec $validationTypeSpec }}
            {{- end }}

            {{- if ne (printf "%T" $validationTypeSpec) "<nil>" }}

              {{/* valueType indicates, how to deal with the value of the param */}}
              {{- $valueType := printf "%T" $value }}

              {{- if in $validationTypeSpec.valid_types $valueType }}
                {{- if eq $validationTypeSpec.class "boolean" }}
                  {{- $valueHandled = true }}
                  {{- if $debug }}
                    {{- warnf "%vkey=%v validated as BOOLEAN: value=%v [type=%T] vs. validationSpec=%v"
                        $debugPrefix $key $value $value $validationSpec }}
                  {{- end }}
                  {{- if $value }}
                    {{- $styleClass = append (printf "%s%s" $styleClassPrefix (delimit $keyStylePath `_`)) $styleClass }}
                  {{- end }}
                {{- else if eq $validationTypeSpec.class "value" }}
                  {{- $styleClass = append (printf "%s%s_%v" $styleClassPrefix (delimit $keyStylePath `_`) .) $styleClass }}
                  {{- $valueHandled = true }}
                  {{- if $debug }}
                    {{- warnf "%vkey=%v validated as VALUE: value=%v [type=%T] vs. validationSpec=%v"
                        $debugPrefix $key $value $value $validationSpec }}
                  {{- end }}
                {{- else if eq $validationTypeSpec.class "ignore" }}
                  {{- $valueHandled = true }}
                  {{- if $debug }}
                    {{- warnf "%vkey=%v validated as IGNORE: value=%v [type=%T] vs. validationSpec=%v"
                        $debugPrefix $key $value $value $validationSpec }}
                  {{- end }}
                {{- else }}
                  {{- errorf "%vkey=%v: value=%v [type=%T] unexpected validationTypeSpec.class=%v from validationTypeSpec=%v"
                      $errorPrefix $key $value $valueType $validationTypeSpec.class
                      (jsonify (dict "indent" "  ") $validationTypeSpec) -}}
                {{- end }}
              {{- else }}
                {{- errorf "%vkey=%v: value=%v with validationSpec=%v has wrong valueType=%v not found in valid_types=%v from validationTypeSpec=%v"
                    $errorPrefix $key $value $validationSpec $valueType $validationTypeSpec.valid_types
                    (jsonify (dict "indent" "  ") $validationTypeSpec) -}}
              {{- end }}
            {{- else }}

              {{/* There is no specific treatment given in validStyles, hence validationSpec
                   is interpreted as a validation value to compare against  */}}

              {{- $resultingValue := and (eq $validationSpec (string $value)) (string $value) }}

              {{- if $debug }}
                {{- warnf "%vkey=%v process value=%v [type=%T]: validationSpec=%v validationTypeSpec=%v resultingValue=%v"
                    $debugPrefix $key $value $value $validationSpec $validationTypeSpec $resultingValue }}
              {{- end }}

              {{- if ne (printf "%T" $validationSpec) "<nil>" }}
                {{- $styleClass = append (printf "%s%s_%v" $styleClassPrefix (delimit $keyStylePath `_`) $resultingValue) $styleClass }}
                {{- $valueHandled = true }}
                {{- if $debug }}
                  {{- warnf "%vkey=%v validated as VERBATIM value=%v [type=%T] vs. validationSpec=%v"
                      $debugPrefix $key $value $value $validationSpec }}
                {{- end }}
              {{- else }}
                {{- errorf "%vkey=%v: value=%v has unexpected type=%T"
                    $errorPrefix $key $value $value }}
              {{- end }}
            {{- end }}

            {{- if not $valueHandled }}
              {{- errorf "%vkey=%v: value=%v [type=%T] could not be parsed"
                  $errorPrefix $key $value $value }}
            {{- end }}

          {{- end }}
        {{- else }}
          {{- errorf "%vkey=%v: validationSpec=%v key not found in validStyles=%v"
              $errorPrefix $key $validationSpec
              (jsonify (dict "indent" "  ") $validStyles) -}}
        {{- end }}
      {{- end }}
    {{- end }}

  {{- end }}
  {{- return $styleClass }}
{{- end }}
